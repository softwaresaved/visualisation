<html>
    <head>
        <meta charset="UTF-8"></meta>
        <title>SSI - Demos - Funding</title>
    </head>

    <body>
        <h1>SSI - Demos - Funding</h1>
        <div id="chart"></div>
        <!-- You need to load D3. -->
        <script src="node_modules/d3/d3.min.js" charset="utf-8"></script>
        <!-- You need to load lodash. -->
        <script src="node_modules/lodash/lodash.min.js" charset="utf-8"></script>
        <!-- Is better to store the script in another document. -->
        <script>
// Raw data that we get from the spreadsheet.
//
// The data can be very messy.
rawData = [
    "EPSRC major BBSRC STFC AHRC",
    "Self-funded",
    "NERC (50%) + ESA (50%)",
    "Institutional",
    "Institutional",
    "",
    "",
    "",
    "EPSRC",
    "EPSRC",
    "EU FP7",
    "DCMS",
    ];

// We just want the first letter from the JACS code.
cleanData = rawData.map(function(value) {
    // This will replace empty strings with "Unknow".
    return value ? value : "Unknow";
});

// Lets count how often some letters show up.
var countedData = _.countBy(cleanData);
var data4pie = [];
for (var key in countedData) {
    data4pie.push({id: key, times: countedData[key]});
}

// The size of the SVG.
var width = 960,
    height = 1160,
    radius = Math.min(width, height) / 2,
    donutRadius = radius / 2;

var color = d3.scale.category20b();  // Define some colors.

var svg = d3.select("#chart")
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .append('g')
    .attr('transform', 'translate(' + (width / 2) +  ',' + (height / 2) + ')'); // Center the g element it in the containing svg element.

var arc = d3.svg.arc()
    .innerRadius(radius - donutRadius)  // Set the arc of the donut.
    .outerRadius(radius);  // Set the arc of the pie.

var pie = d3.layout.pie()
    .value(function(value) { return value.times; })  // Define the data that will be used
    .sort(null);  // Disable sorting.

var path = svg.selectAll('path')
    .data(pie(data4pie))
    .enter()
    .append('path')
    .attr('d', arc)
    .attr('fill', function(value, i) {
        return color(i);
    });

// Add legend.
var legendRectSize = 18;
var legendSpacing = 4;

var legend = svg.selectAll('.legend')
    .data(data4pie)
    .enter()
    .append('g')
    .attr('class', 'legend')
    .attr('transform', function(d, i) {
        var height = legendRectSize + legendSpacing;
        var offset =  height * color.domain().length / 2;
        var horz = -2 * legendRectSize;
        var vert = i * height - offset;
        return 'translate(' + horz + ',' + vert + ')';
                });

legend.append('rect')
    .attr('width', legendRectSize)
    .attr('height', legendRectSize)
    .style('fill', function(d, i) { return color(i); })
    .style('stroke', function(d, i) { return color(i); });

legend.append('text')
    .attr('x', legendRectSize + legendSpacing)
    .attr('y', legendRectSize - legendSpacing)
    .text(function(d) {
        var maxLabelSize = 20;
        var label = d.id;

        // Very poor heuristic!!!
        return label.length > maxLabelSize ? label.substring(0, maxLabelSize - 4) + " ..." : label;
    });
        </script>
    </body>
</html>
